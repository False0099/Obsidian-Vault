我们的攻击目标就是通过我们的内部扫描，只能攻击**内网未授权 mysql**。而我们的未授权的**mysql**, 也就是说我们的没有密码的**mysql**。

## mysql 通信协议
我们的 mysql 在客户端中与我们的数据库服务器连接之间存下面的三种方式
1. unix 套接字 `mysql -uroot -proot`
2. 内存共享/命名管道 `windows` 系统中相对来说常见，
3. TCP/IP 套接字，`mysql -h127.0.0.1 -uroot -proot`。

当我们需要抓取 mysql 通信数据包时必须通过 TCP/IP 套接字连接。

## mysql 认证过程
![[Pasted image 20240507102740.png]]

### 握手认证
握手认证阶段在客户端与服务器建立连接后进行（即在三次握手后进行），交互过程如下：

1）服务器 ===> 客户端：握手初始化消息；由 MySQL 服务器主动发送一个认证的握手数据包；

2）客户端 ===> 服务端：登陆认证消息；客户端收到握手数据包后，将用户的信息（用户名、密码、数据库等信息）打包发送给 MySQL 服务器；

3）服务端 ===> 客户端：认证结果消息；MySQL 服务端认证，返回认证结果给客户端；

- 认证成功：如果服务器通过认证，则发送一个 Ok_pack 包给客户端；
- 认证失败：如果服务器没有通过认证，，则发送一个 error_pack 包；

### 命令执行：
客户端认证成功后，会进入命令执行阶段，交互过程如下：

1）客户端 ===> 服务端：执行命令消息；客户端认证成功后，接下来就可以给 MySQL 服务器发送命令操作数据库，这里用到命令数据包格式；

2）服务器 ===> 客户端：命令执行结果；当 MySQL 服务器成功执行命令后，根据命令类型返回响应结果，并将结果发送给客户端；

- 返回命令执行状态：诸如 insert、delect、update 命令，若执行成功，则返回 ok_pack，反之返回 error_pack；
- 返回结果集：诸如 select 命令，若执行成功，则返回 ResultSetPacket 数据包，反之返回 error_pack；

## 构造攻击数据包
我们的构造攻击的数据包，其实也就是类似于我们的**修改 HTTP**文件，我们只需要去修改我们的 mysql 传输数据包，然后就能够做到修改我们的内容：

### 无密码用户
第一步：连接到我们的对应服务器中的 shell，输入下面的语句：
```
mysql -h 127.0.0.1 -utest -p
```

**注意：我们用 localhost 就代表我们使用的是 unix 套接字，只有使用 127.0.0.1 才是使用 TCP. IP 套接字**

第二步：抓取我们的对应的数据包：
```
tcpdump -ilo0 port 3306 -w sql.pcapng
```


第三步：我们在我们的第一步连接过后，我们就能得到对应的连接语句。
```
select * from students
```

第四步：我们在抓到的包中找到对应的 `login request` 数据，然后再去把我们的对应的 hex 数据复制下来。再按照我们的脚本来**转换为 gopher 语言**。

第五步：运行我们生成的 gopher 语句，我们就可以通过我们的 sql 语句来直接访问我们的目标对象的数据库。我们的对一个的操作。
