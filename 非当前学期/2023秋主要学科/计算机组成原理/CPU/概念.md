## 第六章：中央处理器
### 计算机工作过程
* 加电——》产生 reset 信号——》执行程序——》停机——》停电
* 产生 reset 信号的任务
    * 任务一：使计算机处于初始状态
    * 任务二：从 PC 中取出指令地址
* 控制器作用是协调并控制计算机各部件执行程序的指令序列
### 控制器的组成
* 控制器的功能
    * 取指令
        * 发出指令地址，取出指令的内容
    * 分析指令
        * （1）对操作码译码产生操作相应部件的控制信号
        * （2）根据寻址方式形成操作数地址
    * 执行指令
        * （1）根据分析指令后产生控制信号、操作数地址信号序列，通过 CPU 及输入输出设备的执行实现每条指令的功能
        * （2）结果回送存储器
        * （3）形成下条指令的地址
    * 控制程序和数据的输入和结果输出
    * 对异常情况和某些请求的处理
        * 异常情况的处理：例如算术运算的溢出、数据传送奇偶错
        * 某些请求的处理
            * “中断请求”信号
            * DMA 请求信号
* 控制器的组成
    * 程序计数器（PC）
        * 即地址寄存器，用来存放当前正在执行的指令地址或即将要执行的下一条指令地址
    * 指令寄存器（IR）
        * 用以存放当前正在执行的指令，以便在指令执行过程中控制完成一条指令的全部功能
    * 指令译码器或操作码译码器
        * 对指令寄存器中的操作码进行分析解释，产生相应的控制信号
    * 脉冲源及启停线路
        * 脉冲源参数一定评率的脉冲作为整个机器的时钟脉冲，是机器周期和工作脉冲的基准信号，在机器刚加电时，还应产生一个总清信号（reset）
    * 时序控制信号形成部件
        * 当程序启动后，在 CLK 时钟作用下，根据当前正在执行的指令的需要，产生相应的时序控制信号，并根据被控制功能部件的反馈信号调整时序控制信号
            * 控制存储器
            * 微指令寄存器
                * 控制字段+下址
    *  周期概念
        * 指令周期
            * 完成一条指令所需的时间，包括取指令、分析指令、执行指令
        * 机器周期
            * 也称为 CPU 周期，是 CPU 从内存中读取一个指令的时间，通常等于取指周期
        * 时钟周期
            * 称为节拍脉冲或 T 周期，是基准脉冲信号
    * 三条假设
        * 程序是存放在主存中的，当执行完一条指令后才从主存中取下一条指令（非流水线）
        * 指令的长度是固定的，并限制了寻址方式的多样化
        * 在程序运行前，程序和数据都已存在主存中
* 指令执行过程（运算器和控制器配合）
    * 组成控制器的基本电路
        * 具有记忆功能的触发器以及由它组成的寄存器，计数器和存储单元
        * 没有记忆功能的门电路及由它组成的加法器，算术逻辑运算单元（ALU）和各种逻辑电路
    * 举例
        * 加法
            * 取指令——》计算操作数地址——》取操作数——》执行结果并运算送结果
        * 要能看懂时序图
            * 哪些指令在对应的时间有效
        * 条件转移指令
            * 取指令——》计算地址
    * 控制器的功能就是按每一条指令的要求产生所需的控制信号
    * 产生控制信号的方法
        * 微程序控制
        * 硬布线控制
### 微程序控制计算机的基本工作原理
* 基本概念
    * 微指令
        * 在微程序控制的计算机中，将由同时发出的控制信号所执行的一组微操作
    * 微命令
        * 将指令分为若干条微指令，按次序执行这些微指令。组成微指令的操作即微命令
    * 微程序
        * 计算机的程序由指令序列构成，而计算机每条指令的功能均由微指令序列解释完成，这些微指令序列的集合就叫做微程序
    * 控制存储器
        * 微程序一般是存放在专门的存储器中的，由于该存储器主要存放控制命令（信号）与下一条执行的微指令地址（简称下址）
        * 存储单元内容
            * （1）微指令的控制信号——控制位
            * （2）下条微指令的地址——下址字段
        * 存储芯片：ROM
    * 执行一条指令实际上就是执行一段存放在控制存储器中的微程序
* 实现微程序控制的基本原理
    * 控制信号（23 条）
    * 书上 P 123 页为加法的过程
    * 微指令格式：控制字段+下址字段
    * 23 个控制位，12 个下址位——》容量为 4 K
    * 取址微指令的操作对所有指令都是相同的，所以是一条公用的微指令，其下址由操作码译码产生
* 微程序控制器
* 时序信号及工作脉冲的形成
* 停机和停电的区别
    * 停机
        * 电压：稳定
            * 存放内容：保持
                * 重启 PC 内容：断点指令地址
    * 停电
        * 电压：消失
            * 存放内容：RAM 的内容消失
                * 重启 PC 内容：第一条指令地址
### 微程序设计技术
* 如何缩短微指令字长
    * 直接控制法（容量太小）
        * 编译方法：每一位代表一个控制信号，直接送往相应的控制点
        * 优点：控制简单
        * 缺点：微指令字长过大
    * 字段直接编译法
        * 选出互斥的微指令
        * 每个字段都要留出一个代码，表示本段不发出任何指令（000）
        * 优点：节省微指令的字长
        * 缺点：增加了额外的硬件开销
    * 字段间接编译法
        * 指令之间相互联系的情况
        * 举例：A 为 0-7，B 为 0-3，如果是直接编译——3+2=5，如果是间接编译——3+1=4
        * 编码方法：在字段直接编译法中，译码输出端要兼由另一字段中的某些微命令配合解释
        * 优点：减少了微指令长度
        * 缺点：可能削弱微指令的并行控制能力，同时增加硬件开销
    * 常熟源字段 E (了解)
* 如何减少微指令长度
    * 现行微指令/微地址
        * 现行微指令：当前正在执行的指令
        * 现行微地址：存放现行微指令的控制器存储单元
    * 后继微指令/微地址
        * 后继微指令：下一条要执行的微指令
        * 后继微地址：存放后继微指令的控制器存储单元
    * 增量与下址字段结合产生后继微指令的方法
        * 下址字段分成：转移控制字段 BCF 和转移地址字段 BAF
            * BCF：控制微程序的转移情况
            * BAF：转移后的微指令所在地址
        * BAF 有两种情况
            * 与 uPC 的位数相等——转移灵活，但增加微指令长度
            * 比 uPC 短——转移地址收到限制，但可缩短微指令长度
        * 优点
            *  微指令的下址字段很短，仅用于选择输入 uPC 计数器的某条线路有效
        * 缺点
            * 微程序转移不灵活，使得微程序在控存中的物理空间分配有困难
    * 多路转移方式
        * 一条微指令存在多个转移分支的情况称为多路转移
    * 微中断
        * 1. 微中断请求信号是由程序中断请求信号引起的
        * 2. 在完成现行指令的微程序后响应该微中断请求
        * 3. 由硬件产生对应微中断处理程序在控存中的入口地址
* 如何提高微程序的执行速度
* 微指令格式
    * 水平型微指令——直接控制，字段编译（直接、间接）
        * 特点：在一条微指令中定义并并行执行多个微命令
    * 垂直型微指令
        * 特点：不强调实现微指令的并行控制功能
        * 定义：采用微操作码编译法，由操作码规定微指令的功能
* 微程序控制存储器
    * 一般采用 ROM 存储器
    * 也可采用 RAM，为防止断电后内容消失，则必须开机后将外存中存放的微程序调入控存 RAM，然后才能执行程序。
    * 当前为了能不断扩展指令系统，通常采用 ROM+RAM
* 动态微程序设计
    * 定义：能根据用户要求改变微程序
    * 优点：是计算机能更灵活、有效的适应于各种不同的应用目标
* 控制存储器的操作（P 136）
    * 串行方式
    * 并行方式——比串行多了微指令寄存器
        * 微周期=max (取微指令时间, 执行微指令时间)
        * 由于取微指令、执行微指令同时进行，故对于某些后继微地址的产生根据处理结果而定的微指令，则延迟一个微周期再取微指令
### 硬布线控制的计算机（RISC）——特点快
* 形成操作控制信号的逻辑框图（P 141）
* 操作控制信号的产生
    * 取值周期 cy 1 所产生的信号对所有指令都是相同的，即与当前执行的指令无关，逻辑式得到最简单的形式
    * 通常，同一个控制控制信号在若干条指令的某些周期（或再加上一些条件）中都需要，为此需要把它们组合起来
    * 同种类型的指令所需要的控制信号大部分是相同的，仅有少量区别
    * 在确定指令的操作码时（即对具体指令赋予二进制操作码），为了便于逻辑表达式的化简以减少逻辑电路数量，往往给予特别关注
* 设计组合逻辑电路从而产生需要的控制信号的步骤
    * 1. 实际逻辑问题2. 真值表3. 公式化简4. 逻辑电路图
* 设计目标
    * 使用最少的电路元件达到最高的操作速度
### 流水线工作原理
* 几点结论
    * 每条指令的执行时间不变
    * 每条指令处理结果的时间缩短
    * 流水线处理速率最高时=流水线处于满载的稳定状态
    * 流水线处理速率最低时=流水线未满载状态
    * 为了满足在重叠时间段不同指令的机器周期能够完成指定的操作，将时间段=操作完成的最长时间
    * 为了保证一个周期内流水线的输入信号不变，相邻时间段之间必须设置锁存器或寄存器
    * 除了指令执行流水线，还有运算操作流水线
* 相关问题
    * 流水线阻塞（P 163-6.15）
        * 数据相关产生
            * 假设第二条指令需要的操作数是第一条指令运算的结果，那么出现了数据相关
        * 指令执行时间不同产生
        * 程序转移的影响
        * 异常情况响应中断