在数据传送时，DMA 控制器从 CPU **完全接管对总线的控制**，**数据交换不经过 CPU**，而直接在内存和 I/O 设备之间进行。DMA 方式一般用于高速传送块数据，最大优点是数据交换的速度高，适用于高速成组传送数据。
（相当于我们的 **CPU 把我们的数据传送的任务交给我们的 DMA 来进行，然后再由我们的 DMA 反馈给我们的 CPU**）
## 传送流程：
3 个阶段：传送前预处理 (cpu), 正式传送 (DMA), 传送后处理 (cpu)。
传送前预处理
1. 由 CPU 执行几条输入输出指令，测试设备状态，**向 DMA 控制器的设备地址寄存器中送入设备号并启动设备**，向内存地址计数器中送入起始地址，向字计数器中送入交换的数据字个数。在这些工作**完成后，CPU 继续执行原来的主程序**。(cpu)

正式传送
1. **当外设准备好**发送数据 (输入)或接受数据 (输出)时，它**发出 DMA 请求**，由 DMA 控制器向 CPU 发出总线使用权的请求 (HOLD)。
2. DMA 控制器占用总线后，在 DMA 控制器的控制下，主存与外部设备**完成块数据交换**。

传送后处理
1. 数据传送完成，DMA 控制器以中断通知 CPU 数据传送完成，CPU 停止主程序的执行，转去执行中断服务程序做结束处理工作。比如校验传送数据是否正确；决定继续用 DMA 方式传送下去，还是结束传送误等等。

## DMA 传送方式
在 DMA 方式中，DMA 控制器直接访问内存，与此同时，CPU 可以继续执行程序。DMA 接口与 CPU 共享主存，有可能出现两者争用主存的冲突。

为了有效地分时使用主存，通常 DMA 与主存交换数据时采用采用以下 3 种方法：
 ·停止 CPU 访问内存：
 ·周期挪用；
 ·DMA 与 CPU 交替访问；

说明：若采用多总线结构、双端口存储器等，即可避免这种情况
![[Pasted image 20240104112439.png]]
### 停止 CPU 访问内存：
当外围设备要求传送一批数据时，由 DMA 控**制器发一个停止信号**给 CPU，要求 CPU **放弃对地址总线、数据总线和有关控制总线的使用权**。

DMA 控制器获得总线控制权以后，开始进行数据传送。在一批数据传送**完毕后**，DMA 控制器通知 CPU 可以使用内存，并把总线控制权**交还给 CPU**。

控制简单，适用于高速设备进行成组传送 DMA 传送过程中，主存的存取速度高于外设的工作速度，主存的效
能没有充分发挥。

### 周期挪用：
设备没有 DMA 请求时，CPU 按程序要求访问内存；设备有 DMA 请求，**由 I/O 设备挪用一个或几个内存周期**；与停止 CPU 访内相比，既实现了 I/O 传送，又较好地发挥了内存和 CPU的效率。

两种访内情况：
访内正常：在挪用周期中 CPU 执行程序没有访内，则 DMA 可以正
访内冲突：在挪用周期中，cPU 与 DMA 同时访内，冲突发生；规定 DMA 访内优先。

I/O 设备每一次挪用都有申请、建立和归还总线控制权的过程，传送一个字对内存来说要占用一个周期，但对 DMA 控制器来说需要多个内存周期，适用于 1/0 设备读写周期大于内存存储周期的情况。

### DMA 与 CPU 交替访问
CPU 的工作周期比主存存取周期长，将 CPU 工作周期一分为二，一半 DMA 访存，一半 CPU 访存。
不需要总线使用权的申请，建立和归还过程，只需要总线控制权转移

## DMA 控制器
### 基本组成

DMA 控制器实际上是采用 DMA 方式的外围设备与系统总线之间的接口电路。

![[Pasted image 20231225200648.png]]
![[Pasted image 20231225201037.png]]

(1) 向 CPU 申请 DMA 传送 
(2)在 CPU 允许 DMA 工作时，处理总线控制权的转交
(3)在 DMA 期间管理总线，控制数据传送
(4)确定数据传送的起始地址和数据长度，修正传送过程中的数据地址和数据长度
(5) 在数据块传送结束时，给出 DMA 操作完成的信号

## 例题：
![[Pasted image 20231225201057.png]]
