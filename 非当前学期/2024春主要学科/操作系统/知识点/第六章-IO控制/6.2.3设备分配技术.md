设备分配是指**根据用户的 IO 请求分配所需的设备**。分配的总原则是充分发挥设备的使用效率，尽可能地让设备忙碌，又要避免由于不合理的分配方法造成进程死锁。从设备的特性来看，采用下述三种使用方式的设备分别称为独占设备、共享设备和虚拟设备。
![[Pasted image 20240624174925.png]]



## 考虑因素：
我们给一个谁被分配应该考虑到下面的几个因素：
1. 设备的固有属性，独占设备，共享设备，虚拟设备三种设备应该采用不同的设备分配策略
2. 分配算法：同进程分配
3. 安全性
4. 设备独立性：增加外围设备分配的灵活性，提高外围设备资源利用率。

## 数据结构：
我们的数据结构要求能够描述我们的**通道控制了那些的谁被控制器**，并且还需要描述**我们的设备被哪一个控制器控制了**，同时还需要一个**系统设备表**维护我们一共有哪些设备。

设备分配依据的主要数据结构有下面的几个部分：
1. 设备控制表（COCT）
2. 控制器控制表
3. 通道控制表
4. 系统控制表

### 设备控制表 (DCT)
我们的设备控制表中，存储了我们的每一个设备的关键信息，包括设备类别，设备标识符，设备状态，指向控制表的指针，**设备队列的队首指针**（哪些程序将要使用我们的该设备，这个指针指向一个**PCB**）等等。


![[Pasted image 20240701102304.png]]


### 控制器控制表：
我们的控制器控制表**一个控制器一张**，反应我们的 I.O 控制器的使用状态以及和通道的连接情况。
设备控制器控制我们的设备和内存交换空间，交换数据，而设备控制去又需要请求通道为他服务。因此，每一个 COCT 有一个表象存储我们的通道控制表。
我们的控制器控制表（COCT），当中存储了我们的控制器的关键信息，包括我们的控制器标识符，控制器状态等等，
![[Pasted image 20240619172725.png]]

### 通道控制表（CHCT）：
该表格旨在**通道控制方式**的系统中存在，

我们的通道控制表（CHCT）, 当中存储了我们的控制器的关键信息，包括我们的通道的标识符，通道的状态。我们的**一个通道可以为多个控制器服务**。
![[Pasted image 20240701102417.png]]

### 系统设备表（SDT）：
**系统设备表一个系统只有一张**，该表格记录了我们的已经连接到系统中的**所有物理设备**的表象，所有物理设备的情况，每个物理设备占据一个表项。其中，我们的谁被对应的标目是以**指针形式存储的**。
![[Pasted image 20240701102444.png]]

## 分配类型：
独享分配
共享分配
虚拟分配

## 分配策略：
1)设备分配原则。设备分配应根据设备特性、用户要求和系统配置情况。既要充分发挥设备的使用效率，又要避免造成进程死锁，还要将用户程序和具体设备隔离开。

2)设备分配方式。设备分配方式有静态分配和动态分配两种。$\textcircled{1}静态分配主要用于对独$ 占设备的分配，它在用户作业开始执行前，由系统一次性分配该作业所要求的全部设备、控制器。一旦分配，这些设备、控制器就一直为该作业所占用，直到该作业被撤销。静态分配方式不会出现死锁，但设备的使用效率低。$\textcircled{2}$ 动态分配在进程执行过程中根据执行需要进行。当进程需要设备时，通过系统调用命令向系统提出设备请求，由系统按某

## 分配安全性：
1)安全分配方式。每当进程发出 IO 请求后便进入阻塞态，直到其 IO 操作完成时才被唤醒。这样，一旦进程已经获得某种设备后便阻塞，不能再请求任何资源，而在它阻塞时也不保持任何资源。其优点是设备分配安全，缺点是 CPU 和 IO 设备是串行工作的。

2)不安全分配方式。进程在发出 IO 请求后仍继续运行，需要时又发出第二个、第三个 IO请求等。仅当进程所请求的设备已被另一进程占用时，才进入阻塞态。优点是一个进程可同时操作多个设备，使进程推进迅速；缺点是有可能造成死锁。

## 名称映射：
为了提高设备分配的灵活性和设备的利用率，方便实现 I/O 重定向，引入了设备独立性。设备独立性是指应用程序独立于具体使用的物理设备。

为了实现设备独立性，在应用程序中使用逻辑设备名来请求使用某类设备，在系统中设置一张逻辑设备表 (Logical Unit Table, LUT), 用于将逻辑设备名映射为物理设备名。

LUT 表项包括逻辑设备名、物理设备名和设备驱动程序入口地址；当进程用逻辑设备名来请求分配设备时，系统为它分配一台相应的物理设备，并在 LUT 中建立一个表目，当以后进程再利用该逻辑设备名请求 IO 操作时，系统通过查找 LUT 来寻找对应的物理设备和驱动程序。

## 分配步骤
$\textcircled{1}$ 根据进程请求的物理设备名查找 SDT (注：物理设备名是进程请求分配设备时提供的参数)
$\textcircled{2}$ 根据 SDT 找到 DCT，若设备忙碌则将进程 PCB 挂到设备等待队列中，不忙碌则将设备分配给进程。$\textcircled{3}根据DCT找到COCT，若控制器忙碌则将进程PCB挂到控制器等待队列中，不忙碌则将控制器分配$ 给进程。
$\textcircled{4}$ 根据 COCT 找到 CHCT，若通道忙碌则将进程 PCB 挂到通道等待队列中，不忙碌则将通道分配给进程。

缺点：

(1)用户编程时必须使用“物理设备名”, 底层细节对用户不透
明，不方便编程
2 若换了一个物理设备，则程序无法运行
3 若进程请求的物理设备正在忙碌，则即使系统中还有同类型
的设备，进程也必须阻塞等待

![[Pasted image 20240701102656.png]]
