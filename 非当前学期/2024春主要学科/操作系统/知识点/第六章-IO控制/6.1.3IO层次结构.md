IO 软件涉及的面很宽，**设计的设备种类很多**，我们的操作系统希望为我们的所有 IO 谁被都提供一个统一的接口，**这个统一的接口就要求我们能够实现我们的层次结构**。


又因为我们的 IO 控制，往下与硬件有著密切关系，在上又与虚拟存储器系统、文件系统和用户直接交互，它们都需要 I/O 软件来实现 I/O 操作。

于是，我们可以考虑使用我们的**分层设计**的思路，将我们的 IO 控制谁被**分层**，每一层负责**为上一层提供接口，封装下一层的功能**。例如我们的**计算机网络**就是采用这样的方法。
![[Pasted image 20240625220625.png]]


![[Pasted image 20240619161151.png]]

## 用户层 IO 软件：
实现与用户交互的接口，**用户可直接调用在用户层提供的**、与 I/O 操作有关的库函数，对设备进行操作。一般而言，大部分的 IO 软件都在操作系统内部，但仍有一小部分在用户层，包括与用户程序链接在一起的**库函数**。用户层软件必须通过一组系统调用来获取操作系统服务。这一层是为了我们能够更快速的使用我们的接口，而**封装的设备独立性软件**。例如，我们的 C 语言中提供的 printf 函数。（将我们的心中的想法转换为我们的**人的需求的编码**）

## 设备独立性软件（重点）
用于实现用户程序与设备驱动器的统一接口、设备命令、设备的保护及设备的分配与释放等，同时为设备管理和数据传送提供必要的存储空间。

设备独立性也称设备无关性，使得**应用程序独立于具体使用的物理设备**。为实现设备独立性而引入了逻辑设备和物理设备这两个概念。在**应用程序中，使用逻辑设备名来请求使用某类设备**；而在系统实际执行时，必须将逻辑设备名映射成物理设备名使用。

该层要求向上一层维护统一的调用接口（read/write 系统调用），同时还要实现设备的保护（类似于文件保护），以及我们的**差错处理**。以及我们对于设备的**分配和回收**，建立**逻辑设备名到物理设备名**的映射，例如我们将我们的打印机 1 映射到我们的对应的设备。例如我们的系统调用中的某一号调用。
![[Pasted image 20240619204632.png]]

设备独立性软件，也就是**把我们的系统调用翻译成对应设备的控制语言**。例如我们的 JVM 就是把我们的对应的内容转换为我们的

## 设备驱动程序：
**请求的操作和数据被转换为适当的 I.O 指令，通道命令和控制器命令序列**。（类似于我们把我们的 C 语言程序转换为我们的汇编语言，这一步就是把我们的汇编语言转换为我们的机器语言）

与硬件直接相关，负责具体实现系统对设备发出的操作指令。
同时，我们的**不同的设备需要有不同的驱动程序**，这是因为我们的设备的内部结构不太相同。**硬件特性**要求我们使用不同的驱动程序。常以进程形式存在。设备驱动程序向上层用户程疗提供一组标准接口，设备具体的差别被设备驱动程序所封装，用于接收上层软件发来的抽象 I/O 要求，转换为具体要求后，发送给设备控制器，控制 IO 设备工作；它也将由设备控制器发来的信号传送给上层软件，从而为 I/O 内核子系统隐藏设备控制器之间的差异。同时也要**设施设备寄存器**。**也就是把我们的

## 中断处理程序：
**IO 操作的实际调度发生在这一层，负责处理我们的中断，收集和报告 IO 状态**

当我们的 IO 任务完成后，IO 控制器会发送一个中断信号，系统会根据中断信号类型找到相应的中断处理程序并执行。中断处理程序的对应流程如下所示：

用于保存被中断进程的 CPU 环境，转入相应的中断处理程序进行处理，处理完毕再恢复被中断进程的现场后，返回到被中断进程。
中断处理层的主要任务有：进行进程上下文的切换，对处理中断信号源进行测试，读取设备状态和修改进程状态等。由于中断处理与硬件紧密相关，对用户而言，应尽量加以屏蔽，因此应放在操作系统的底层，系统的其余部分尽可能少地与之发生联系。
![[Pasted image 20240619205239.png]]

## 整体流程：

例如，
1.当用户要读取某设备的内容时，通过操作系统提供的 read 命令接口，这就经过了用户层。

2.操作系统提供给用户使用的接口，一般是统一的通用接口，也就是几乎每个设备都可以响应的统一命令，如 read 命令，用户发出的 read 命令，首先经过**设备独立层进行解析**，然后交往下层。

3.接下来，**不同类型的设备对 read 命令的行为会有所不同**，如磁盘接收 read 命令后的行为与打印机接收 read 命令后的行为是不同的。因此，需要**针对不同的设备，把 read 命令解析成不同的指令**，这就经过了设备驱动层。

4.命令解析完毕后，需要中断正在运行的进程，转而执行 read 命令，这就需要中断处理程序。

5.最后，命令真正抵达硬件设备，硬件设备的控制器按照上层传达的命令操控硬件设备，完成相应的功能。