**注意，再计算偏移量的时候一定要除以 8 计算出我们的字节号**。
## 计算校验和：

步骤：每次从头取 16 位排成一列相加，取反得到我们的校验和。![[Pasted image 20240629120121.png]]

我们每一次去我们**一行的一般**，我们就有下面的计算：

![[Pasted image 20240629120250.png]]



## 数据包分片
![[Pasted image 20240627153624.png]]

**注意，我们分片后我们的数据段必须是 8 的整数倍**。因此我们的数据包分片不能用简单的总长度/大小来计算、

![[Pasted image 20240627153837.png]]


4-15 一个 3200 位长的 TCP 报文传到 IP 层，加上 160 位的首部后成为数据报。下面的互联网由两个局域网通过路由器连接起来，但第二个局域网所能传送的最长数据帧中的数据部分只有 1200 位，因此数据报在路由器必须进行分片。试问第二个局域网向其上层要传送多少比特的数据 (这里的“数据”当然指的是局域网看见的数据)?
![[Pasted image 20240629121403.png]]

4-20 一个数据报长度为 4000 字节(固定首部长度)。现在经过一个网络传送，但此网络能够传送的最大效据长度为1500 字节。试问应当划分为几个短些的数据报片？各数据报片的数据字段长度、片偏移字段和 MF 标志应为何数值：
![[Pasted image 20240702160212.png]]


![[Pasted image 20240703001213.png]]
在 IP 层下面的每种数据链路层都有自己的帧格式，其中包括帧格式中的数据字段的最大长度，这称为最大传输单位 (MTU)。1500-20=1480,2000-1480=520, 所以原 IP 数据报经过第一个网络后分成了两个 IP 小报文，第一个报文的数据部分长度是 1480 B, 第二个报文的数据部分长度是 520 B。(除最后一个报片外的)**所有报片的有效载荷都是 8 B 的倍数**。576-20=556, 但 556 不能被 8 整除，所以分片时的数据部分最大只能取 552。第一个报文经过第 2 个网络后，1480-552×2=376< 576, 变成数据长度分别为 552 B、552 B、376 B 的 3 个 IP 小报文：第 2 个报文 520 < 552, 因此不用分片。因此到达目的主机时，原 2000 B 的数据被分成数据长度分别为 552 B、552 B、376 B、520 B 的 4 个小报文。


## ARP 相关计算：
![[Pasted image 20240629121805.png]]
![[Pasted image 20240629121820.png]]

## 路由器，路由聚合
![[Pasted image 20240629121840.png]]

我们计算我们的路由器吓一跳，其实就是在计算我们的**前缀匹配是什么**。
![[Pasted image 20240629122249.png]]



![[Pasted image 20240702161025.png]]




## 子网划分：
4-19 某单位分配到一个地址块 129.250/16。该单位有 4000 台机器，平均分布在 16 个不同的地点。试给每一个
地点分配一个地址块，并算出每个地址块中 IP 地址的最小值和最大值。

定长分配：子网号是定长的，我们**每一个子网分到的主机数是一定的**，我们的下面的子网是固定的，那么这种情况下，我们的每一个**网络中的大小是相同的**，我们只需要确定我们的**子网和主机的界限即可**。

![[Pasted image 20240702155349.png]]

变长分配：我们的子网号**长度不一**，我们通过**二叉树**的方法来进行我们的构造。
![[Pasted image 20240702155646.png]]

我们的具体方法如下：
我们首先将我们的需要分配的子网数目按照我们的**大小**来进行排序，然后我们就可以每一次先选择我们的**最大的那一个，找到第一个满足这一个大小的网络是多少位**，然后我们再去按照我们的对应的方案去分配即可。

4-25 一个自治系统分配到的 IP 地址块为 30.138.118/23, 并包含有 5 个局域网，其连接图如图 4-77 所示，每个局
域网上的主机数分别标注在图 4-77 上。试给出每一个局域网的地址块 (包括前缀)。
![[Pasted image 20240702161246.png]]

第一步：我们每一次首先去计算，我们给每一个局域网需要**分配的 IP 地址的数目**，注意，我们的相连的路由器需要一个 IP 地址，

第二步：考虑是**定长分配或者是边长分配**，我们假设我们按照我们的定长分配，是否可以满足我们的需求，如果可以，我们就按照我们的定长分配，否则，我们就按照我们的变长分配。

第三步：在进行我们的变长分配的时候，我们考虑构造一个二叉树，构造出来的结构就是我们的**分配方案**。这里，我们考虑计算我们每一个需要多大的**子机数目**。
![[Pasted image 20240702162015.png]]
![[Pasted image 20240702162635.png]]

一个大公司有一个总部和三个下属部门。公司分配到的网络前缀是 192.77.33/24。公司的网络布局如图 4-78 所示。总部共有 5个局域网，其中的 LAN $_1\sim\mathrm{LAN}_4$ 都连接到路由器 $\mathbb{R}_1$ 上，$\mathbb{R}_1$ 再通过 LAN $_5$ 与路由器 $\mathbb{R}_2$ 相连。$\mathbb{R}_2$ 和远地的三个部门的局域网 LAN $_{6}$~LAN $_{8}$ 通过广域网相连。每一个局域网旁边标明的数字是局域网上的主机数。试给每一个局域网分配一个合适的网络前缀。
![[Pasted image 20240702162825.png]]

![[Pasted image 20240702162811.png]]

4-47 某单位分配到一个地址块 14.24.74.0/24。该单位需要用到三个子网，对这三个子地址块的具体要求是：子网
$\mathbb{N}_1$ 需要 120 个地址，子网 $\mathbb{N}_2$ 需要 60 个地址，子网 N $_3$ 需要 10 个地址。请给出地址块的分配方案。

![[Pasted image 20240702170013.png]]



## CIDR 计算：
![[Pasted image 20240702160802.png]]

![[Pasted image 20240702160621.png]]
![[Pasted image 20240702163818.png]]


![[Pasted image 20240702163834.png]]

![[Pasted image 20240703002635.png]]
(1) IP 地址空间 192.168.1.0/24 被均分给销售部和技术部两个子网，将 192.168.1.0/24 后 32-24=8 位写成二进制形式，其中主机号的位用 x 表示，每个 x 可以取 0 或 1。二进制位用红色表示。得到 192.168.1. Xxxxxxxx, 因为要均匀划分给两个子网，取出其中 $\lceil\log_22\rceil=1$ 位作为子网号，得到两个子网：
192.168.1.0 xxxxxxx 192.168.1.1 xxxxxxx 对于 192.168.1.0 xxxxxx, 即 192.168.1.0/25, 将其主机号位全取 0，得到其网络地址：192.168.1.0 将其主机号位全取 1，得到其广播地址：192.168.1.127 其余为其可分配的主机号，192.168.1.1~192.168.1.126 对于 192.168.1.1 xxxxxxx, 即 192.168.1.128/25, 将其主机号位全取 0，得到其网络地址：192.168.1.128
![[Pasted image 20240703002933.png]]

（2）(2)假设主机 192.168.1.1 向主机 192.168.1.208 发送一个总长度为 1500 B 的 IP 分组，IP 分组的头部长度为 20 B, 路由器在通过接口 F 1 转发该 IP 分组时进行了分配。若分片时尽可能分为最大片，则一个最大 IP 分片封装数据的字节数是多少？至少需要分为几个分片？每个分片的片偏移量是多少？
主机 192.168.1.1 向主机 192.168.1.208 发送一个总长度为 1500 B 的 IP 分组，销售部子网的
MTU=1500 B, 技术部子网的 MTU=800 B。因此，该 IP 分组能够顺利在销售部子网中进行传输，
1500 B>800 B, 进入技术部子网时要进行分片。
分片先去除原来的 IP 分组的头的 20 B, 对数据载荷 1500 B-20 B=1480 B 进行分片，分片后每个分片的数据载荷不能超过 800 B-20 B=780 B, 且要求是 8 B 的整数倍 (片偏移字段以 8 B 为单位)。
第一问。最大 IP 分片封装数据的字节数为 $\lfloor 780$ B/ 8 $\rfloor \times 8= 776$ B .
第二问。至少需要分为「1480 B/776 B $\rceil=2$ 个分片。

第三问。第一个分片的片偏移量是 O B / 8 B = 0, 第二个分片的片偏移量是 **776 B / 8 B** = 97。
## NAT 转换：
![[Pasted image 20240703001727.png]]

**R3要开启 NAT 功能**，H2的地址为192.168.1.2，随机选择一个端口号，NAT 转换为 R3在公有网络的 IP 地址203.10.2.6，随机选择一个端口号，H3的地址为192.168.1.3，随机选择一个端口号，NAT 转换为 R3在外网的 IP 地址203.10.2.6，随机选择另一个端口号（不能和前面选择的冲突）。可以配置 NAT 表如下（举例，配置不唯一）：
![[Pasted image 20240703002120.png]]

**R2要开启 NAT 功能**，这里是进行 NAT 服务器配置，Web 服务器的 IP 地址为192.168.1.2，默认端口号80（Web 服务器默认使用 HTTP 协议进行访问，HTTP 使用 TCP 的端口号为80），NAT 转换为 R2在外网的 IP 地址203.10.2.2，一般情况下，NAT 服务器配置不支持端口号改变（例如华为的 NAT 路由器），因此选择的端口号仍为80。可以配置 NAT 表如下：
![[Pasted image 20240703002321.png]]

(2) 由于启用了 NAT 服务，H2发送的数据报 P 的源 IP 地址应该是 H2的内网地址，目的地址应该是 R2的外网 IP 地址，源 IP 地址是192.168.1.2，目的 IP 地址是203.10.2.2。

R3转发后，将数据报P的源IP地址改为R3的外网IP地址，目的IP地址仍然不变，源IP地址是203.10.2.6，目的IP地址是203.10.2.2。

R2转发后，将数据报P的目的IP地址改为Web服务器的内网地址，源地址仍然不变，源IP地址是203.10.2.6，目的IP地址是192.168.1.2。