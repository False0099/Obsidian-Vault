## NAT 简介
我们的 NAT 技术就是：我们在输出的时候，都是用一个统一的地址，然后我们在内部转换的时候，在用我们的内瓤地址来进行转换。

也就是说，我们内部的消息要发送的时候，我们先根据我们发送的地址，把我们的 IP 地址，映射为一个新的公共的 IP 地址，用于我们和外网进行连接。

我们收到消息的时候，我们先接收我们的这一个 IP 地址，然后再把我们的这一个地址转换为我们的内部的 IP 地址，然后再把对应的内容转换过去。

网络地址转换(NAT)是指通过将专用网络地址(如 Intranet)转换为公用地址(如 Intermet), 从而对外隐藏内部管理的 IP 地址。它使得整个**专用网只需要一个全球 IP 地址**就可以与因特网连通，由于专用网本地 IP 地址是可重用的，所以 NAT 大大节省了 IP 地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险。

![[Pasted image 20240610161455.png]]


这样，我们在我们的子网内部，可以通过我们的内部 IP 地址，进行直接的转换，而在我们的子网外部，想要和其他的设备交互的时候，就需要用我们的 `NAT` 技术, 将我们的内部的不同的主机，**映射为不同的端口**。

## 动机：
只能从我们的 ISP 申请一个 ip 地址的时候，我们要怎么样才能够和我们的其他的所有的元素之间进行联系？

同时，这样做的好处还有：本地 IP 设备发生变化时，无需通告外界网络。同时，在我们更改 ISP 申请的外部地址时，我们的内部地址也不需要修改。

同杨，我们的 NAT 地址使得我们的内部设备对于我们的外部网络**不可见**。也就是不能够直接寻址。非常的安全。

## 特殊地址：
此外，为了网络安全，划出了部分 IP 地址为私有 IP 地址。私有 IP 地址只用于 LAN, 不用于 WAN 连接 (因此私有 IP 地址不能直接用于 Internet, 必须通过网关利用 NAT 把私有 IP 地址转换为 Internet 中合法的全球 IP 地址后才能用于Internet), 并且允许私有 IP 地址被 LAN 重复使用。
这有效地解决了 IP 地址不足的问题。私有 IP 地址网段如下：
![[Pasted image 20240702000435.png]]

**我们的私有 IP 地址网段，也就是我们限制了，我们的内部路由能够采用的 IP 地址的范围有哪些**。

## 实现：
我们想要实现我们的 NAT 技术，我们需要完成下面的三个步骤：
#### 替换
1. 利用我们的 (NATIP 地址，新端口号)来替换每一个外出 IP 数据包的（源 IP 地址，源端口号）

#### 记录
将我们的每一对 (NATIP 地址，新端口号)和我们的 (源 IP 地址，源端口号)的替换信息存储到我们的 NAT 转换表中。

#### 再替换
根据我们的 NAT 转换表，利用（源 IP 地址，源端口号）替换每一个进入内网 IP 数据包的（目的 IP 地址，目的端口号），即（NATIP 地址，新端口号）

## 工作流程：
第一步：我们的 NAT 覆盖内网中的某一个主机向我们的某一个外网发送一个数据包。
第二步：我们的这一个数据包在我们的 NAT 路由器的时候，应该发生一个转换，我们的 NAT 路由器会把我们的主机的 IP 信息和端口号修改为我们的 NAT 路由器的公网 IP 和一个端口号并记录到我们的 NAT 表中。
第三步：
![[Pasted image 20240610162347.png]]

第四步：
我们的路由器进行我们的检索，并且把我们的对应数据替换到我们的目的信息。
![[Pasted image 20240610162414.png]]

## 性能分析：
![[Pasted image 20240610162502.png]]

## NAT 穿透问题
客户期望直接连接内网地址为的 10.0.0.1 服务器，那么这个时候我们的客户是不能直接通过我们的服务器来进行访问的。而我们这个时候唯一可见的地址就是我们的 `NAT` 路由器地址。

### 静态配置:
将静态配置 NAT，将特定端口的连接请求转发给服务器，例如，我们总是把我们的 (138,76,29,7:2500)转发到我们的 (10.0.0.1,25000)当中

### 利用 UPnp 协议
我们的这一种方法的目的时，将我们内部的服务器，和我们的路由器都需要支持我们的 Upnp 协议，通过这个协议，我们的路由器可以**自动学习**到我们的网络中连接的 `NAT` 服务，获得 `NAT` 的公共 IP 地址，在我们的 `NAT` 中自动添加对应的映射关系。
![[Pasted image 20240610163006.png]]

### 中继：
我们的 NAT 内部的客户通过与我们的中继服务器连接，然后再由我们的中继服务器与我们的外部客户之间的连接。也就实现了我们的连接功能。