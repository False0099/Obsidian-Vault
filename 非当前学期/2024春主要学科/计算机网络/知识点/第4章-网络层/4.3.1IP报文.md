一个 IP 分组由首部和数据部分组成。首部前一·部分的长度固定，共 20B,是所有 IP 分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。IP 数据报的格式如图 4.4 所示。
![[Pasted image 20240701233219.png]]

## IP 头部
我们的 IP 数据头要求，我们**最小为 20 byte**，最大**60 byte**。
一个 IP 分组由首部和数据部分组成。首部**前部分的长度固定，共 20 B**, 是所有 IP 分组必须具有的。在首部固定部分的后面是一些**可选字段，其长度可变**，用来提供错误检测及安全等机制。
### 头部组成
第一行：
1. 版本号（可以取值为 4 或 6）（4 bit）
2. 首部长度（表示我们 **IP 报头的长度，不添加可选项固定为 20，否则不变**）（4 bit）, 最大可以表示 (60 B)。**实际值为二进制值乘以 4**.
2. 区分服务类型 (TOS)（**不在 QOS 场景下无意义**）: 表示 IP 数据报期望获得什么服务。一般情况下不使用。
3. 总长度: (16 bit)（IP 首部+IP 数据的总长度）, 根据我们的总长度的字长限制，我们可以知道IP 数据包的理论最大长度是 65535 字节。
第二行：
1. **标识**（ID, 16 bit）（表示我们的数据是哪一个整体的片段的，表示我们的整体**组号**）它是一个计数器，每产生一个数据报就加 1, 并赋值结标识子段。但**并不是“序号”**(因为 IP 是无连接服务)。当一个数据报的长度超过网络的 MTU 时，必须分片，此时**每个数据报片都复制一次标识号，以便能正确重装成原来的数据报**。

2. **标志** (3 bit, 保留+MF（更多片）+DF (禁止分片)) 标志字段的最低位为 MF（more fragment）, MF=1 表示后面还有分片，MF=0（no more fragment） 表示最后一个分片。标志字段中间的一位是 DF (dont fragment), 只有当 DF=0 时才允许分片。

3. 片偏移（13 bit）它指出较长的分组在**分片后**，某片在原分组中的相对位置。片偏移以8 个字节为偏移单位。除最后一个分片外，每个分片的长度一定是 8 B 的整数倍。(**对于 DF=1 的字段无意义**)

第三行：控制信息
8. 生存时间（TTL）: 指示数据报在网络中可以通过的路由器数目的最大值，我们每一次跳一个路由器，我们的 TTL 就会减一。经过最多多少个路由器。（防止我们在我们的链路中出现环路现象）

9. 协议：（指出这一个数据包携带的数据采用了**什么样的上层协议**，TCP, UDP 1=icmp, 6=tcp, 17=udp, 89=ospf）

10. 头部校验和（只检验我们的**数据头部**是否出现了错误）**检验 IP 报头长度**，补码求和的算法进行处理。计算前，这个位置全部设置为 0，计算方法与我们的 TCP 相同，

第四行：定位信息
11. 目的 IP，源 IP（定位我们的每一个链路上的内容）

第五行：
选项字段：一般来说不填充
填充：保证我们是四个字节的倍数。
