# 一、何为拥塞
拥塞控制是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载。出现拥塞时**端点并不了解拥塞发生的细节**，对通信连接的端点来说，拥塞往往表现为通信**时延的增加**。

拥塞控制与流量控制的区别：拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及**所有的主机**、所有的路由器，以及与降低网络传输性能有关的所有因素。相反，流量控制往往是指点对点的通信量的控制，是个**端到端的问题** (接收端控制发送端), 它所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。当然，拥塞控制和流量控制也有相似的地方，即它们都通过控制发送方发送数据的速率来达到控制效果。

例如，某个链路的传输速率为 10 Gb/s, 某大型机向一台 PC 以 1 Gb/s 的速率传送文件，显然网络的带宽是足够大的，因而不存在拥塞问题，但如此高的发送速率将导致 PC 可能来不及接收，因此必须进行流量控制。但若有 100 万台 PC 在此链路上以 IMb/s 的速率传送文件，则现在的问题就变为网络的负载是否超过了现有网络所能承受的范围。


发送方在确定发送报文段的速率时，既要根据接收方的接收能力，又要从全局考虑不要使网
络发生拥塞。因此，TCP 协议要求发送方维护以下两个窗口：
1)接收窗口 rwnd, 接收方根据目前接收缓存大小所许诺的最新窗口值，反映**接收方的容量**。由接收方根据其放在 TCP 报文的首部的窗口字段通知发送方。

2)拥塞窗口 cwnd, 发送方根据自己估算的网络拥塞程度而设置的窗口值，反映**网络的当前容量**。只要网络未出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入网络的分组数。发送窗口的上限值应取接收窗口 rwnd 和拥塞窗口 cwnd 中较小的一个，即
发送窗口的上限值 $=\min[rwnd,cwnd]$

路由器无法处理高速到达的数据而被迫丢弃数据的现象叫做拥塞。也就是我们**发送方发送的数据过多时，我们的处理方式**。我们的总体思路是：把我们的过多的数据进行分段。这种情况下，我们的**网络层可以不用分片**。
![[Pasted image 20240607211018.png]]

# 二、何为拥塞控制

TCP流量控制时为了平衡一个链接中接收方和发送方的速度匹配问题，当发送方发现发送速度大于接收方的接收速度时动态调整发送速度。

但是成千上万的 TCP 链接共享着整个网络基础设施，当网络上这些 TCP 都在传输数据时，网络有可能就会拥塞，TCP 的拥塞控制就是在传输自己数据的同时实时掌握整个网络的负载，然后基于整个网络的负载来动态调整自己的发送速度。

![[Pasted image 20240607211812.png]]


# 三、网络拥塞的开销

拥塞时路由器丢失数据，丢失后基于可靠性传输的机制，发送方会重传数据，重传会再次加大网络负载，导致更大的开销。

在多路由器的情况下，会导致更大的资源浪费，比如数据有A传递到B经过了三个路由器，结果被第三个路由器给丢弃了。这样前两个路由器的工作全被白白浪费。如下图所示，R3拥塞，A--》B的数据到达R3之后最终被丢弃了，R1、R2的工作被白白浪费。

![](https://img2020.cnblogs.com/blog/737467/202011/737467-20201112223327283-522427988.png)

由此可见，拥塞控制势在必行。

# 控制方法：
### 检测拥塞：
我们的拥塞的检测发生时，可能会出现下面的几个特征：包括但不限于：
1. 丢包的发生：如果我们的丢包次数大于某一个与之（超时，或者三次冗余 ack）就代表网络拥塞，需要减少 cwnd 的 size。
2. 连续接收到三个相同的包。（这个时候，往往意味着我们传送的包发生了错误，**有一个包没有发过去**而这个错误导致了我们的接收方给我们发送了三个以上的相同的 ack 包）
3. 确认代表网络畅通，可以加大 cwnd 的 size。确认的越快 cwnd 增加的越快（反之亦然）。自计时（self-clocking）

### 慢启动处理：
慢启动就是 TCP 启动后的发送速度慢慢的进行提速，这样才能便于感知网络的状况。**发送方应该维护一个叫做 `cwnd` 的变量，以及我们的慢开始变量**。

慢启动的核心算法：
1. 刚开始cwnd=1个**MSS**（max segment size）
2. 每当收到一个ack，cwnd=cwnd+1。这样每过一个RTT。cwnd便会翻倍：$cwnd=cwnd*2$，这是指数级增加
3. 当cwnd=ssthresh（慢启动**阈值**，slow start threshold）时，停止指数级增加，进入避免拥塞流程。

![](https://img2020.cnblogs.com/blog/737467/202011/737467-20201113232702275-2119567389.png)

![](https://img2020.cnblogs.com/blog/737467/202011/737467-20201115174555377-1394954277.png)

### 拥塞避免
拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢增大，具体做法是：每经过一个**往返时延** RTT 就把发送方的拥塞窗口 cwnd 加 1,而不是加倍，使拥塞窗口 cwnd 按线性规律缓慢增长(即加法增大), 这比慢开始算法的拥塞窗口增长速率要缓慢得多。

![](https://img2020.cnblogs.com/blog/737467/202011/737467-20201115191328561-6574335.png)
根据 cwnd 的大小执行不同的算法，可归纳如下：

·当 cwnd<ssthresh 时，使用慢开始算法。
·当 cwnd> ssthresh 时，停止使用慢开始算法而改用拥塞避免算法。
·当 cwnd=ssthresh 时，既可使用慢开始算法，又可使用拥塞避免算法 (通常做法)。
### 拥塞处理：
无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞(未按时收到确认), 就要把**慢开始门限** ssthresh 设置为出现拥塞时的发送方的 cwnd 值的一半(但不能小于 2)。然后把**拥塞窗口 cwnd 重新设置为 1**,**执行慢开始算法**。这样做的目的是迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完。
![[Pasted image 20240702104953.png]]

### 快重传快恢复
在上一节介绍的 TCP 可靠传输机制中，快重传技术使用了冗余 ACK 来检测丢包的发生。同样，**冗余 ACK** 也用于网络拥塞的检测 (丢了包当然意味着网络可能出现了拥塞)。快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。

当发送方连续收到**三个重复的 ACK 报文**时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时。此时，我们认为发生了**快重传**，我们进行我们的**快恢复算法**。

快恢复算法的原理如下：当发送方连续收到三个冗余 ACK(即重复确认)时，执行“乘法减小”算法，把**慢开始门限 ssthresh 设置为此时发送方 cwnd 的一半**。这是为了预防网络发生拥塞。但发送方现在认为网络很可能没有发生(严重)拥塞，否则就不会有几个报文段连续到达接收方，也不会连续收到重复确认。因此与慢开始不同之处是它把 **cwnd 值设置为慢开始门限 ssthresh 改变后的数值**，然后开始执行拥塞避免算法(“加法增大”),使拥塞窗口缓慢地线性增大。
 ![[Pasted image 20240702110012.png]]
 


![[Pasted image 20240607212632.png]]


## 性能分析：
![[Pasted image 20240607213417.png]]


![[Pasted image 20240607213444.png]]


![[Pasted image 20240607213521.png]]


## 公平性：
![[Pasted image 20240607213636.png]]

![[Pasted image 20240607213821.png]]
