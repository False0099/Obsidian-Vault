我们的事务恢复也就是我们的**事务的回滚**，我们在这一个章节，考虑到我们应该怎么样去恢复我们的数据库的状态。于是，我们就可以考虑使用我们的**日志**。我们的**数据文件**和我们的**日志文件**是分开的，这样，我们才能够保证我们的数据是可以恢复的。

## 数据库故障：
我们的数据库故障包括我们的下面的种类：
1. 事务内部的故障，包括非预期的，不能由事务内部程序处理。如运算溢出、并发死锁而被撤销等。这个时候，我们采取的策略应该是：进行我们的事务撤销。
2. 系统故障，包括操作系统故障，硬件错误，
3. 介质错误：
4. 计算机病毒：

为什么数据库的故障会导致我们的事务错误？
因为事务执行的结果**必须是使数据库从一个一致性状态变到另一个一致性状态**。如果数据库系统运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是不一致的状态。

## 恢复技术：
事务恢复（Transaction Recovery）是指在数据库管理系统中，当事务执行失败或中断时，确保数据库能够回到一致状态的过程。事务恢复的主要目标是**保持数据的一致性和完整性，即确保数据库从不一致状态恢复到一致状态**。

## 数据转储
在我们的数据库恢复技术当中，存在下面两种方法：

我们不管什么操作，一定是**先写日志文件**，**再去写数据文件**。
![[Pasted image 20240627170031.png]]

上面的信息是我们的日志操作和我们的个人操作的对应的内容是什么样的。

一是通过数据存储方式：所谓转储即 DBA **定期地将数据库复制到磁带或另一个磁盘上保存起来**的过程。当数据库遭到破坏后可以将后备副本重新装入，将数据库恢复到转储时的状态。
#### 静态转储
在系统中无运行事务时进行的转储操作。静态转储简单，但必须等待正运行的用户事务结束才能进行。同样，新的事务必须等待转储结束才能执行。这会降低数据库的可用性。

#### 动态转储：
指**转储期间允许对数据库进行存取或修改**。动态转储可克服静态转储的缺点，它不用等待正在运行的用户事务结束，也不会影响新事务的运行。但是，转储结束时后援副本上的数据并不能保证正确有效。因为转储期间运行的事务可能修改了某些数据，使得后援副本上的数据不是数据库的一致版本。

为此，必须把转储期间各事务对数据库的修改活动登记下来，**建立日志文件**( 109 file ）。这样，后援副本加上日志文件就能得到数据库某一时刻的正确状态。转储还可以分为海量转储和增量转储两种方式。

#### 海量转储：
指每次转储全部数据库。

#### 增量转储：
指每次只转储上一次转储后更新过的数据。从恢复角度看，使用海量转储得到的后备副本进行恢复一般说来更简单些。但如果数据库很大，事务处理又十分频繁，则增量转储方式更实用更有效。

例子：

## 日志文件：
日志文件是用来记录事务对数据库的更新操作的文件，事务故障恢复和系统故障必须使用日志文件，在动态转储方式中必须建立日志文件，后援副本和日志文件综合起来才能有效的恢复数据库，静态转储方式中，也可以建立日志文件。

日志文件主要又两种格式：以记录为单位的日志文件和以数据块为单位的日志文件。登记日志文件时必须遵循两条原则：

1. 登记的次序严格按并发事务执行的时间次序
2. 必须先写日志文件，后写数据块。

对数据库的修改写到数据库中和把表示这个修改的日志记录写到日志文件中是两个不同的操作。有可能在这两个操作之间发生故障，即这两个写操作只完成一个。如果先写了数据库修改，而在运行记录中没有登记这个修改，则以后就无法恢复这个修改了。如果先写日志，但没有修改数据库，按日志恢复数据库时只不过是多执行一次不必要的 UNDO 操作，并不会影响数据库的正确性。所以**为了安全，一定要先写日志文件**，即首先把日志记录写到日志文件中，然后写数据库的修改。这就是“**先写日志文件**”的原则。

![[Pasted image 20240625170359.png]]

